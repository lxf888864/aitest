<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>在线计算器</title>
    <style>
        :root {
            color-scheme: light;
            font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
            --bg: #f5f7fb;
            --card: #ffffff;
            --text: #1f2a44;
            --muted: #6b7a90;
            --primary: #3b82f6;
            --accent: #10b981;
            --border: #e3e8f1;
        }
        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
        }
        .container {
            max-width: 980px;
            margin: 0 auto;
            padding: 40px 20px 56px;
            display: grid;
            gap: 24px;
            grid-template-columns: 1.2fr 0.8fr;
        }
        header {
            grid-column: 1 / -1;
            text-align: center;
            margin-bottom: 8px;
        }
        header h1 {
            margin-bottom: 8px;
        }
        .card {
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 12px 30px rgba(18, 38, 63, 0.08);
            padding: 24px;
            border: 1px solid var(--border);
        }
        .status {
            background: #f0f5ff;
            color: #2b4ea1;
            padding: 10px 14px;
            border-radius: 10px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        .expression {
            border: 1px dashed var(--border);
            border-radius: 12px;
            padding: 14px;
            font-size: 16px;
            color: #36415f;
            background: #fbfcff;
            display: grid;
            gap: 6px;
        }
        .expression .value {
            font-size: 20px;
            font-weight: 600;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
        }
        input {
            width: 100%;
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid #d0d7e2;
            font-size: 16px;
        }
        .keypad {
            display: grid;
            gap: 12px;
            grid-template-columns: repeat(4, 1fr);
            margin-top: 20px;
        }
        .key {
            border: none;
            padding: 12px 16px;
            border-radius: 10px;
            background: #f4f6fb;
            color: #2a3655;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            border: 1px solid #d0d7e2;
        }
        .key.primary {
            background: var(--primary);
            color: #fff;
            border-color: transparent;
        }
        .key.accent {
            background: var(--accent);
            color: #fff;
            border-color: transparent;
        }
        .key:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 16px rgba(61, 109, 242, 0.18);
        }
        .result {
            margin-top: 16px;
            background: #ecfdf5;
            border: 1px solid #d1fae5;
            border-radius: 12px;
            padding: 14px;
            display: grid;
            gap: 6px;
            font-size: 16px;
            color: #047857;
        }
        .result span {
            font-weight: 600;
        }
        .hint {
            color: var(--muted);
            font-size: 13px;
        }
        .side {
            display: grid;
            gap: 16px;
        }
        .panel-title {
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 8px;
        }
        ul {
            margin: 0;
            padding-left: 18px;
            color: var(--muted);
        }
        .example {
            background: #fef3c7;
            border: 1px solid #fde68a;
            padding: 12px 14px;
            border-radius: 10px;
            color: #92400e;
            font-weight: 600;
        }
        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>在线计算器</h1>
        <p class="hint">支持四则运算、括号与常见科学函数（角度制）。</p>
    </header>
    <div class="card">
        <div class="status">状态：解析表达式（支持运算优先级与括号）</div>
        <div class="expression">
            <div class="hint">当前表达式</div>
            <div class="value" id="expressionBar">--</div>
        </div>
        <div style="margin-top: 16px;">
            <label for="expressionInput">表达式输入</label>
            <input id="expressionInput" type="text" placeholder="例如：10-2*3" />
        </div>

        <div class="keypad">
            <button class="key" onclick="appendToken('7')">7</button>
            <button class="key" onclick="appendToken('8')">8</button>
            <button class="key" onclick="appendToken('9')">9</button>
            <button class="key" onclick="appendOperator('/')">÷</button>
            <button class="key" onclick="appendToken('4')">4</button>
            <button class="key" onclick="appendToken('5')">5</button>
            <button class="key" onclick="appendToken('6')">6</button>
            <button class="key" onclick="appendOperator('*')">×</button>
            <button class="key" onclick="appendToken('1')">1</button>
            <button class="key" onclick="appendToken('2')">2</button>
            <button class="key" onclick="appendToken('3')">3</button>
            <button class="key" onclick="appendOperator('-')">-</button>
            <button class="key" onclick="appendToken('0')">0</button>
            <button class="key" onclick="appendToken('.')">.</button>
            <button class="key" onclick="appendOperator('+')">+</button>
            <button class="key primary" onclick="evaluateExpression()">=</button>
            <button class="key" onclick="appendToken('(')">(</button>
            <button class="key" onclick="appendToken(')')">)</button>
            <button class="key" onclick="appendOperator('^')">^</button>
            <button class="key" onclick="appendFunction('sqrt')">√</button>
            <button class="key" onclick="appendFunction('sin')">sin</button>
            <button class="key" onclick="appendFunction('cos')">cos</button>
            <button class="key" onclick="appendFunction('tan')">tan</button>
            <button class="key" onclick="appendFunction('log')">log</button>
            <button class="key" onclick="appendFunction('ln')">ln</button>
            <button class="key accent" onclick="clearInputs()">清空</button>
        </div>
        <div class="result">
            <div>结果：<span id="resultValue">--</span></div>
            <div class="hint" id="resultMessage">请输入表达式。</div>
        </div>
    </div>
    <div class="side">
        <div class="card">
            <p class="panel-title">支持能力</p>
            <ul>
                <li>运算优先级（× ÷ 优先于 + -）</li>
                <li>括号嵌套与函数计算</li>
                <li>即时显示表达式与结果</li>
            </ul>
        </div>
        <div class="card">
            <p class="panel-title">示例表达式</p>
            <div class="example">10 - 2 * 3 = 4</div>
        </div>
    </div>
</div>
<script>
    const expressionInput = document.getElementById('expressionInput');

    function syncExpressionBar() {
        const value = expressionInput.value.trim();
        const displayValue = value === '' ? '--' : formatExpression(value);
        document.getElementById('expressionBar').textContent = displayValue;
    }

    function appendToken(token) {
        expressionInput.value += token;
        syncExpressionBar();
    }

    function appendOperator(operator) {
        expressionInput.value += operator;
        syncExpressionBar();
    }

    function appendFunction(fnName) {
        const mapping = {
            sqrt: 'sqrt(',
            sin: 'sin(',
            cos: 'cos(',
            tan: 'tan(',
            log: 'log(',
            ln: 'ln('
        };
        expressionInput.value += mapping[fnName] || '';
        syncExpressionBar();
    }

    function formatExpression(expression) {
        return expression.replaceAll('*', '×').replaceAll('/', '÷');
    }

    async function evaluateExpression() {
        const expression = expressionInput.value.trim();
        if (expression === '') {
            updateResult('--', true, '请输入表达式。');
            syncExpressionBar();
            return;
        }

        try {
            const response = await fetch('/api/eval', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ expression })
            });
            const data = await response.json();
            if (!response.ok) {
                updateResult(data.message || '计算失败', true);
                return;
            }
            updateResult(data.result, false, '计算成功。');
        } catch (error) {
            updateResult('服务不可用，请稍后重试', true);
        }
    }

    function updateResult(value, isError, message) {
        const resultValue = document.getElementById('resultValue');
        const resultMessage = document.getElementById('resultMessage');
        resultValue.textContent = value;
        resultMessage.textContent = message || (isError ? '请检查输入。' : '计算成功。');
        resultMessage.style.color = isError ? '#c0392b' : '#56607a';
    }

    function clearInputs() {
        expressionInput.value = '';
        updateResult('--', false, '请输入表达式。');
        syncExpressionBar();
    }

    expressionInput.addEventListener('input', syncExpressionBar);
    syncExpressionBar();
</script>
</body>
</html>
